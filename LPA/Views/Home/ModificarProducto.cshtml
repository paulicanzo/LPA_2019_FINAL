@model int

@{
    Layout = null;
}


@{
    Layout = null;
}

<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Productos LPA</title>

    <!-- Bootstrap core CSS -->
    <link href="~/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="~/css/shop-homepage.css" rel="stylesheet">
    <style>
        button {
            border: 1px #AAA solid;
            padding: 4px 10px;
        }

        .hide {
            display: none;
        }
    </style>

</head>

<body>
    <button type="button" id="volver" class="btn btn-light">Inicio</button> <!--funcionalidad del botón de inicio.-->
    <script>
        var idProducto = @Model;
        var leyenda = "";
        var btnLeyenda=""
        switch (idProducto) { //si el producto es -99 se agrega el producto, caso contrario, se modifica. 
            case -99:
                leyenda = "Agregar producto";
                btnLeyenda = "Agregar";
                break;
            default:
                leyenda = "Modificar producto";
                btnLeyenda = "Modificar";
        }
    </script>
    <!-- Page Content -->
    <div class="container">
        <div class="row">
            <div class="col-lg-2">
            </div>

            <div class="col-lg-9">
                <div class="row">
                    <div id="containerProducto">
                        <form id="formProducto">
                            <fieldset>
                                <legend id="leyendaForm"></legend>
                                <div class="form-group">
                                    <fieldset>
                                        <label class="control-label" for="TituloProducto">Titulo</label>
                                        <input class="form-control" id="TituloProducto" type="text">
                                    </fieldset>
                                </div>
                                <div class="form-group">
                                    <label for="DescripcionTexto">Descripcion</label>
                                    <textarea class="form-control" id="DescripcionTexto" rows="5"></textarea>
                                </div>
                                <div class="form-group">
                                    <label class="control-label">Precio</label>
                                    <div class="form-group">
                                        <div class="input-group mb-3">
                                            <div class="input-group-prepend">
                                                <span class="input-group-text">$</span>
                                            </div>
                                            <input class="form-control" id="PrecioProducto" aria-label="Precio" type="number">
                                            <div class="input-group-append">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="FotoProducto">File input</label>
                                    <input class="form-control-file" id="FotoProducto" aria-describedby="fileHelp" type="file"  accept="image/*" required>
                                    <small class="form-text text-muted" id="fileHelp"></small>
                                </div>
                                <button id="BtnEnviarDatos" class="btn btn-outline-success" type="button">Enviar</button>
                                <button id="BtnCancelar" class="btn btn-outline-danger" type="button">Cancelar</button>
                            </fieldset>
                            <br />
                        </form>

                    </div>
                </div>
                <!-- /.row -->
            </div>
            <!-- /.col-lg-9 -->
        </div>
        <!-- /.row -->
    </div>


    <div class="appButtonDiv" id="appButtonDiv"></div>
    <!-- /.container -->
    <!-- Footer -->
    <footer class="py-5 bg-dark">
        <div class="container">
            <p class="m-0 text-center text-white">Copyright &copy; LPA 2019</p>
        </div>
        <!-- /.container -->
    </footer>
    <script src="~/vendor/jquery/jquery.js" type="text/javascript"></script>
    <script src="~/vendor/bootstrap/js/bootstrap.bundle.min.js" type="text/javascript"></script>


    <script>
        var host = window.location.origin;
        var apiEndPoint = host + "/api/v1/Productos/" + idProducto;
        var domContainerProductos;
        var enviarModificar;

        $(document).ready(function () {           
            domContainerProductos = $("#containerProducto");
            $("leyendaForm").innerText = leyenda;
            $("BtnEnviarDatos").innerText = btnLeyenda;
            var nombre = $("#TituloProducto")
            var precio = $("#PrecioProducto")
            var descripcion = $("#DescripcionTexto")
            
            var enviarModificar = function () {
                var formData = new FormData();
                formData.append("titulo", nombre.val())
                formData.append("precio", precio.val())                
                formData.append("descripcion", descripcion.val())
                $.each($('#FotoProducto')[0].files, function (i, file) {
                    console.log(file)
                    formData.append('file-' + i, file);
                });     
                $.ajax({
                    url: apiEndPoint,
                    type: 'PUT',
                    method: 'PUT',
                    data: formData,
                    cache: false,
                    contentType: false,
                    processData: false,
                    success: function () {
                        window.location = window.location.origin;
                    },
                    error: function (e) {
                        domContainerProductos.innerHTML = JSON.stringify(e) + "<h1>Error</h1>";
                    }
                });
            };
            var enviarAgregar = function () {
                //Enviar agregar
                var formData = new FormData();
                formData.append("titulo", nombre.val())
                formData.append("precio", precio.val())
                formData.append("descripcion", descripcion.val())
                $.each($('#FotoProducto')[0].files, function (i, file) {
                    console.log(file)
                    formData.append('file-' + i, file);
                });
                $.ajax({
                    url: apiEndPoint,
                    type: 'POST',
                    method: 'POST',
                    data: formData,
                    cache: false,
                    contentType: false,
                    processData: false,
                    success: function () {
                        window.location = window.location.origin;
                    },
                    error: function (e) {
                        domContainerProductos.innerHTML = JSON.stringify(e) + "<h1>Error</h1>";
                    }
                });
            }
            var buscarProducto = function () {
                $.ajax({
                    url: apiEndPoint,
                    type: 'GET',
                    dataType: 'json',
                    success: function (prod) {
                        var urlImagen = host + prod.productImagePath;
                        var TituloProducto = prod.productName;
                        var PrecioProducto = prod.productPrice;
                        var DescripcionProducto = prod.productDescription;

                        var div = document.createElement("div");
                        div.innerHTML = `<img src="${urlImagen}" alt="" width="50%" height="50%">`;

                        $("#containerProducto").prepend(div);
                        $("#TituloProducto").val(TituloProducto);
                        $("#DescripcionTexto").val(DescripcionProducto);
                        $("#PrecioProducto").val(PrecioProducto);
                    },
                    error: function () {
                        domContainerProductos.innerHTML = "<h1>Error</h1>";
                    }
                });
            }
                        
            if (idProducto !== -99) {
                buscarProducto();
            }            

            document.getElementById("volver").onclick = function () {
                window.location  = window.location.origin;
            };
            document.getElementById("BtnCancelar").onclick = function () {
                window.location  = window.location.origin;
            };
            document.getElementById("BtnEnviarDatos").onclick = function () {
                //Validar datos
                debugger;
                if (!nombre.val() || 0 === nombre.val().length || !nombre.val().trim()) { alert("Titulo vacio"); return;}
                if (!descripcion.val() || 0 === descripcion.val().length || !descripcion.val().trim()) { alert("Descripción vacia"); return; }
                if (!precio.val() || 0 === precio.val().length || !precio.val().trim() || !$.isNumeric(precio.val()) || !(parseFloat(precio.val())>0)) { alert("Precio vacio o incorrecto"); }
               
                if (idProducto === -99) {
                    if (imagen[0].files[0] == undefined) {
                        alert("No se selecciono un archvivo");
                        return false;
                    }
                    enviarAgregar();
                }
                else
                {
                    enviarModificar();
                }                
            };
        })
    </script>

</body>

</html>


